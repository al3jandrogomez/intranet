$(document).ready(function(){$("#certificado").change(handleParsingCertFile);$("#llave").change(handleParsingPrivKeyFile)});function signatureError(a){}var privateKeyBuffer=new ArrayBuffer(0);var certificateBuffer=new ArrayBuffer(0);function handleParsingPrivKeyFile(a){var c=new FileReader();var b=a.target.files;c.onload=function(d){privateKeyBuffer=d.target.result};c.readAsArrayBuffer(b[0])}function handleParsingCertFile(a){var c=new FileReader();var b=a.target.files;c.onload=function(d){certificateBuffer=d.target.result};c.readAsArrayBuffer(b[0])}function signData(c,h,g){var a=isWCAPISupported();if(a.invalid){return a}var d;var j=arrayBufferToString(certificateBuffer);var b=j.replace(/(-----(BEGIN|END) CERTIFICATE-----|\r\n)/g,"");if(b.charAt(0)==="M"){d=window.atob(b)}else{d=j}var f;var i=arrayBufferToString(privateKeyBuffer);var e=i.replace(/(-----(BEGIN|END) PRIVATE KEY-----|\r\n)/g,"");if(e.charAt(0)==="M"){f=window.atob(e)}else{f=i}validateKeysAndSign(d,f,c,h,g);return a}function isWCAPISupported(){var c;var a;var b={invalid:false,message:""};if(window.msCrypto){c=window.msCrypto}else{if(window.crypto){c=window.crypto}else{b.message="<center><span style='font-weight:bold'>Tu Navegador no soporta Web Cryptography API! Esta pagina no funcionará. [No Crypto Namespace]</center>";b.invalid=true;return b}}if(!window.Promise){b.message="<center><span style='font-weight:bold'>Tu Navegador no soporta \"Promises\"! Esta pagina no funcionará</center>";b.invalid=true;return b}if(c.webkitSubtle){a=c.webkitSubtle}else{if(c.subtle){a=c.subtle}else{b.message="<center><span style='font-weight:bold'>Tu Navegador no soporta Web Cryptography API! Esta pagina no funcionará. [No Crypto Namespace]</center>";b.invalid=true;return b}}return b}function validateKeysAndSign(b,h,c,l,k){try{var f=forge.asn1.fromDer(b);var i=forge.pki.certificateFromAsn1(f);var e=i.subject.attributes;var g;var a;for(var j in e){g=e[j];if(g.name!==undefined&&g.name==="serialName"){a=g.value}}if(a===null){return false}a=a.replace("/","").trim();if(a===c){SDSgLib_openPKCS8PrivateKey(h,l).then(function(p){if(p[0]!="0"){$("#firma-modal").modal("hide");bootbox.dialog({closeButton:false,message:"La llave privada esta corrupta o la contraseña es incorrecta",title:"Error",buttons:{success:{label:"Aceptar",className:"btn-success",callback:function(){$("#firma-modal").modal("show")}}}});return false}var o=forge.asn1.fromDer(p);var m=forge.pki.privateKeyFromAsn1(o);if(_bnToHex(i.publicKey.e)===_bnToHex(m.e)&&_bnToHex(i.publicKey.n)===_bnToHex(m.n)){var n=parseInt(2);signAndSend(l,h,b,n,k)}else{$("#firma-modal").modal("hide");bootbox.dialog({closeButton:false,message:"El certificado no corresponde con la llave privada",title:"Atencion",buttons:{success:{label:"Aceptar",className:"btn-success",callback:function(){$("#firma-modal").modal("show")}}}});false}},function(m){$("#firma-modal").modal("hide");bootbox.dialog({closeButton:false,message:"La llave privada esta corrupta o la contraseña es incorrecta",title:"Error",buttons:{success:{label:"Aceptar",className:"btn-success",callback:function(){$("#firma-modal").modal("show")}}}});return false})}else{$("#firma-modal").modal("hide");bootbox.dialog({closeButton:false,message:"El certificado no corresponde con el usuario",title:"Atencion",buttons:{success:{label:"Aceptar",className:"btn-success",callback:function(){$("#firma-modal").modal("show")}}}});return false}}catch(d){$("#firma-modal").modal("hide");bootbox.dialog({closeButton:false,message:"Ocurrio un error durante la Firma del Documento.\n Favor de reportarlo!!!",title:"Error FSI001",buttons:{success:{label:"Aceptar",className:"btn-success",callback:function(){$("#firma-modal").modal("show")}}}});return false}}function resetModalFirma(){var a=$("#certificate_file").parent();var b=$(a).html();$(a).html(b);a=$("#privkey_file").parent();b=$(a).html();$(a).html(b);$("#password").val("");$("#tokenTOTP").val("");$("#certificate_file").change(handleParsingCertFile);$("#privkey_file").change(handleParsingPrivKeyFile)}function _bnToHex(a){var c=a.toString(16);if(c[0]>="8"){c="00"+c}return c}function generateDigest(a){var c=forge.md.sha1.create();c.start();c.update(a);var d=c.digest();var b=d.toHex();return b}function signAndSend(b,f,g,c,e){try{var a=pkcs7FromHash(b,f,g,c,$.xmlHash);a.then(function(i){var h=btoa(arrayBufferToString(i),false,true);e(h)},function(h){$("#signature").val("");if(h.message.indexOf("Error while decrypting private key")>=0){$("#firma-modal").modal("hide");bootbox.dialog({closeButton:false,message:"La llave privada esta corrupta o la contraseña es incorrecta",title:"Atencion",buttons:{success:{label:"Aceptar",className:"btn-success",callback:function(){$("#firma-modal").modal("show")}}}});return false}else{$("#firma-modal").modal("hide");bootbox.dialog({closeButton:false,message:"Ocurrio un error durante la Firma del Documento.\n Favor de reportarlo!!!",title:"Error FSI002",buttons:{success:{label:"Aceptar",className:"btn-success",callback:function(){$("#firma-modal").modal("show")}}}});return false}})}catch(d){$("#firma-modal").modal("hide");bootbox.dialog({closeButton:false,message:"Ocurrio un error durante la Firma del Documento.\n Favor de reportarlo!!!",title:"Error FSI001",buttons:{success:{label:"Aceptar",className:"btn-success",callback:function(){$("#firma-modal").modal("show")}}}});return false}};