var SD_TripleDES="1.2.840.113549.3.7";var SDSGL_ERR_01="Error while decoding pkcs#8 encrypted private key stream";var SDSGL_ERR_02="Invalid or unsupported algorithm: ";var SDSGL_ERR_03="Error while decrypting private key";var SDSGL_ERR_04="Error while deriving symmetric key";var ADJUSTED_3DES_KEY_LENGTH=24*2;function str2ab(e){var b=new ArrayBuffer(e.length);var a=new Uint8Array(b);for(var c=0,d=e.length;c<d;c++){a[c]=e.charCodeAt(c)}return b}function StringToBinary(c){var f,e,d,b,a,g;a=c.length;f=[];b=false;for(d=g=0;0<=a?g<a:g>a;d=0<=a?++g:--g){e=String.prototype.charCodeAt.call(c,d);if(e>255){b=true;f=null;break}else{f.push(e)}}if(b===true){return unescape(encodeURIComponent(c))}else{return String.fromCharCode.apply(null,Array.prototype.slice.apply(f))}}function StringToUint8Array(c){var g,b,a,e,d,f;g=StringToBinary(c);b=g.length;a=new ArrayBuffer(b);e=new Uint8Array(a);for(d=f=0;0<=b?f<b:f>b;d=0<=b?++f:--f){e[d]=String.prototype.charCodeAt.call(g,d)}return e}function uint8ArrayToHexStr(b){var a="";var c;for(var d=0;d<b.byteLength;d++){c=b[d].toString(16);if(c.length<2){c="0"+c}a+=c}return a}function arrayBufferToHexString(e){var b=new Uint8Array(e);var a="";var c;for(var d=0;d<b.byteLength;d++){c=b[d].toString(16);if(c.length<2){c="0"+c}a+=c}return a}function arrayBufferToString(c,g,h){var d=new Uint8Array(c);var f=d.length;var b="";for(var e=0;e<f;e+=65535){var a=65535;if(e+65535>f){a=f-e}b+=String.fromCharCode.apply(null,d.subarray(e,e+a))}if(b){if(g){g(b)}}else{if(h){h("buffer was invalid")}}return b}function binStringToHex(f){var d=[],g;var a="";for(var e=0,b=f.length;e<b;++e){g=f.charCodeAt(e);a=a+(g>>4).toString(16)+(g&15).toString(16)}return a}function rawStringToBuffer(d){var c,b=d.length,a=new Array(b);for(c=0;c<b;++c){a[c]=d.charCodeAt(c)&255}return new Uint8Array(a).buffer}function decipher3DES(c,b,d){var a=CryptoJS.TripleDES.decrypt({ciphertext:c},b,{iv:d,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7});return a}function cipher3DES(b,a,d){var c=CryptoJS.TripleDES.encrypt(CryptoJS.enc.Hex.parse(b),CryptoJS.enc.Hex.parse(a),{iv:CryptoJS.enc.Hex.parse(d),mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7});return c.ciphertext}function makeOddParity(a,f){var e=0;var d=0;var b=0;var g=0;for(e=0;e<f;e++){for(b=0,d=0;d<8;d++){g=1;g=g<<d;if((a[e]&g)!=0){b++}}if(b%2==0){a[e]=a[e]^1}}return forge.util.binary.hex.encode(a)}function SDSgLib_openPKCS8PrivateKey(a,b){return new Promise(function(m,n){var c;var e;if(window.msCrypto){c=window.msCrypto}else{if(window.crypto){c=window.crypto}else{n(Error("Web Cryptography API not supported. [No Crypto Namespace]"))}}if(c.webkitSubtle){e=c.webkitSubtle}else{if(c.subtle){e=c.subtle}else{n(Error("Web Cryptography API not supported. [No Crypto.Subtle Namespace]"))}}var h="SHA-1";var g=org.pkijs.fromBER(rawStringToBuffer(a));if(g.offset===(-1)){n(Error(SDSGL_ERR_01))}var l=new org.pkijs.simpl.pkcs8.ENCRYPTED_PRIVATEKEY_INFO_WP52({schema:g.result});var k=l.encryptionAlgorithm.parameters.encryptionScheme.algorithm_id;if(k!=SD_TripleDES){n(Error(SDSGL_ERR_02+k))}var d=l.encryptionAlgorithm.parameters.EncAlgWPBKDF2params.keyDevParams.iterationCount;var j=binStringToHex(arrayBufferToString(l.encryptionAlgorithm.parameters.EncAlgWPBKDF2params.keyDevParams.salt.value_block.value_hex));var f=CryptoJS.enc.Hex.parse(binStringToHex(arrayBufferToString(l.encryptedData.value_block.value_hex,false,true)));var i=forge.util.createBuffer(b);SgLib_PBKDF2(i,j,d,192).then(function(q){q=makeOddParity(forge.util.binary.hex.decode(q),192/8);var r=CryptoJS.enc.Hex.parse(q);var p=CryptoJS.enc.Hex.parse(binStringToHex(arrayBufferToString(l.encryptionAlgorithm.parameters.encryptionScheme.algorithm_params.value_block.value_hex,false,true)));var o=decipher3DES(f,r,p);var s=o.toString(CryptoJS.enc.Latin1);if(s.length<=0){n(Error(SDSGL_ERR_03))}if(s[0]!="0"){console.log("Unable to decrypt ciphered private key "+new Date());i=forge.util.createBuffer(forge.util.encodeUtf8(b));SgLib_PBKDF2(i,j,d,192).then(function(u){u=makeOddParity(forge.util.binary.hex.decode(u),192/8);var v=CryptoJS.enc.Hex.parse(u);var t=decipher3DES(f,v,p);var w=t.toString(CryptoJS.enc.Latin1);if(w.length<=0){console.log("Deciphered binary private key length is zero "+new Date());n(Error(SDSGL_ERR_03))}if(w[0]!="0"){n(Error(SDSGL_ERR_03))}else{m(w)}})}else{m(s)}})})}function SDSgLib_cipherPKCS8Key(b,a){return new Promise(function(j,k){var c;var f;var g="SHA-1";var d=2048;if(window.msCrypto){c=window.msCrypto}else{if(window.crypto){c=window.crypto}else{k(Error("Web Cryptography API not supported. [No Crypto Namespace]"))}}if(c.webkitSubtle){f=c.webkitSubtle}else{if(c.subtle){f=c.subtle}else{k(Error("Web Cryptography API not supported. [No Crypto.Subtle Namespace]"))}}var h=new Uint8Array(8);c.getRandomValues(h);var e=new Uint8Array(8);c.getRandomValues(e);var i=uint8ArrayToHexStr(h);SgLib_PBKDF2(a,i,d,192).then(function(o){o=makeOddParity(forge.util.binary.hex.decode(o),192/8);var l=uint8ArrayToHexStr(e);var n=cipher3DES(arrayBufferToHexString(b),o,l);var m={cipherText:n,salt:h,iv:e,iterations:d};create_PKCS8_enc(m,SD_PBES2,SD_PBKDF2,SD_TripleDES).then(function(p){j(p)},function(p){k(Error("Error while encoding ciphered key: "+p.message))})})})};